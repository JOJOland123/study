<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <script>
        // 模拟 200 个下载请求的数组（实际替换为真实请求）
        const totalTasks = Array.from({ length: 10 }, (_, i) => () =>
            new Promise((resolve) => {
                // 模拟下载过程（随机 0.5~3 秒延迟）
                const delay = 500 + Math.random() * 2500;
                setTimeout(() => {
                    console.log(`文件 ${i + 1} 下载完成，耗时 ${delay.toFixed(0)}ms`);
                    resolve(i + 1);
                }, 1e3);
            })
        );

        // 并发控制器
        async function parallelDownload(tasks, maxConcurrent) {
            const results = [];      // 存储所有结果
            const executing = new Set(); // 正在执行的 Promise 集合

            for (const task of tasks) {
                // 包装任务以便追踪完成状态
                const p = task().then(res => {
                    executing.delete(p); // 完成后从执行集合移除
                    return res;
                });
                executing.add(p);
                results.push(p);

                // 当达到并发上限时，等待任意一个任务完成
                if (executing.size >= maxConcurrent) {
                    await Promise.race(executing);
                }
            }

            // 等待所有剩余任务完成
            return Promise.all(results);
        }

        // 执行下载（最大并发数 5） 
        parallelDownload(totalTasks, 5)
            .then(() => console.log("所有下载完成！"))
            .catch(err => console.error("下载出错:", err));
    </script>
</body>

</html>